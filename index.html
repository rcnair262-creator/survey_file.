<!DOCTYPE html>
<html>
<head>
  <title>Election Survey System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* BASIC STYLING */
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; padding: 20px; color: #333; }
    .box { background: white; padding: 25px; max-width: 900px; margin: auto; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; color: #444; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
    label { font-weight: 600; font-size: 14px; color: #555; display: block; margin-top: 10px; }
    input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; box-sizing: border-box; }
    input:focus, select:focus { border-color: #2b7cff; outline: none; }
    button { background: #2b7cff; color: white; border: none; font-weight: bold; cursor: pointer; }
    button:hover { background: #1a66e0; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.red { background: #d43b3b; } button.red:hover { background: #b02a2a; }
    button.green { background: #28a745; } button.green:hover { background: #218838; }
    
    .member-card { background: #f9f9f9; padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; }
    
    /* SL INPUT STYLE */
    .sl-input {
      background: #ffeb3b; color: #000; padding: 8px; width: 80px;
      border-radius: 6px; font-weight: bold; border: 2px solid #e6d328;
      text-align: center; font-size: 18px;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .status-active { color: green; font-weight: bold; }
    .status-inactive { color: red; font-weight: bold; }
  </style>
</head>
<body>

<script>
/* ‚úÖ YOUR URL IS NOW CONFIGURED BELOW */
const LIVE_URL = "https://script.google.com/macros/s/AKfycbxsiECJkDUscrGRW5lp579YZZTYgpomb-mNR2s6Pt6XzhNy86EH0ogu9WLM5AByWwrkqw/exec";

let currentSheetId = "";
</script>

<div class="box" id="dashboard">
  <h2>üìÇ Cluster Dashboard</h2>
  
  <label>Select Existing File</label>
  <button id="btnLoad" onclick="loadFiles()">üîÑ Refresh File List</button>
  <select id="fileList"><option>Loading...</option></select>
  <button class="green" onclick="selectFile()">Open Selected File</button>

  <hr>

  <label>Create New Cluster</label>
  <input id="newCluster" placeholder="Enter Cluster Name (e.g., Ward 5)">
  <button onclick="createNewCluster()">‚ûï Create New File</button>

  <hr>
  <button onclick="openFilter()">üîç Advanced Search & Filter</button>
</div>

<div class="box" id="familyBox" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>üìù Family Entry</h2>
    <div style="text-align:right;">
      <label style="margin:0; font-size:12px;">SL No:</label>
      <input type="number" id="manualSL" class="sl-input" value="1">
    </div>
  </div>

  <label>House Name</label>
  <input id="house" placeholder="Enter House Name">

  <label>Number of Eligible Members</label>
  <input type="number" id="count" placeholder="0" onchange="createMembers()">

  <div id="members"></div>

  <button id="btnSave" class="green" onclick="saveFamily()">üíæ Save Family & Fix Order</button>
  <button class="red" onclick="backToDashboard()">Back to Dashboard</button>
</div>

<div class="box" id="filterBox" style="display:none;">
  <h2>üìä Filter & Summary</h2>
  <button class="red" onclick="backToDashboard()">Back</button>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <select id="fActive"><option value="">All Status</option><option>Active</option><option>Not Active</option></select>
    <select id="fParty"><option value="">All Party</option><option>NDA</option><option>UDF</option><option>LDF</option><option>OTH</option></select>
  </div>
  <select id="fReligion"><option value="">All Religion</option><option>Hindu</option><option>Muslim</option><option>Christian</option><option>Others</option></select>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <input id="fBook" placeholder="Book No"><input id="fSerial" placeholder="Serial No">
  </div>

  <button onclick="applyFilter()">Apply Filter</button>
  
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <button class="green" onclick="openExcel()">Open Sheet</button>
    <button class="green" onclick="downloadCSV()">Download CSV</button>
  </div>
  
  <div id="filterSummary" style="margin-top:15px; padding:10px; background:#e8f0fe;"></div>
  <div id="filterResults" style="overflow-x:auto;"></div>
</div>

<script>
// --- PAGE NAVIGATION ---
function showPage(id) {
  document.querySelectorAll('.box').forEach(b => b.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}

function backToDashboard() { showPage("dashboard"); }

// --- API FUNCTION ---
async function apiCall(data) {
  try {
    let res = await fetch(LIVE_URL, {
      method: "POST",
      body: JSON.stringify(data)
    });
    return await res.json();
  } catch (err) {
    alert("Connection Error: " + err.message);
    return null;
  }
}

// --- FILE OPERATIONS ---
async function loadFiles() {
  let btn = document.getElementById("btnLoad"); btn.disabled = true;
  let data = await apiCall({ mode: "listFiles" });
  let list = document.getElementById("fileList"); list.innerHTML = "";

  if (data && data.files) {
    data.files.forEach(f => {
      let opt = document.createElement("option"); opt.value = f.id; opt.textContent = f.name; list.appendChild(opt);
    });
    if(data.files.length === 0) list.innerHTML = "<option>No files found</option>";
  }
  btn.disabled = false;
}

async function selectFile() {
  currentSheetId = document.getElementById("fileList").value;
  if (!currentSheetId) return alert("Select a file");

  let data = await apiCall({ mode: "getLastSL", sheetId: currentSheetId });
  if (data) {
    // Suggest Max + 1, but user can change it
    let nextSL = Number(data.lastSL) + 1;
    document.getElementById("manualSL").value = nextSL;
    showPage("familyBox");
  }
}

async function createNewCluster() {
  let name = document.getElementById("newCluster").value.trim();
  if (!name) return alert("Enter cluster name");

  let btn = document.querySelector("button[onclick='createNewCluster()']");
  btn.disabled = true; btn.textContent = "Creating...";

  let data = await apiCall({ mode: "createFile", clusterName: name });
  btn.disabled = false; btn.textContent = "‚ûï Create New File";

  if (data) {
    if (data.status === "EXISTS") return alert("File already exists!");
    currentSheetId = data.sheetId;
    document.getElementById("manualSL").value = 1; // New file starts at 1
    showPage("familyBox");
  }
}

// --- FAMILY ENTRY ---
function createMembers() {
  let count = Number(document.getElementById("count").value);
  let box = document.getElementById("members");
  box.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    box.innerHTML += `
      <div class="member-card">
        <h4>Member ${i}</h4>
        <input placeholder="Name" class="inp-name">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input placeholder="Book No" class="inp-book">
          <input placeholder="Serial No" class="inp-serial">
        </div>
        <select class="sel-religion"><option>Hindu</option><option>Muslim</option><option>Christian</option><option>Others</option></select>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <select class="sel-party"><option>NDA</option><option>UDF</option><option>LDF</option><option>OTH</option></select>
          <select class="sel-active"><option>Active</option><option>Not Active</option></select>
        </div>
      </div>`;
  }
}

async function saveFamily() {
  let house = document.getElementById("house").value.trim();
  let count = Number(document.getElementById("count").value);
  let slValue = Number(document.getElementById("manualSL").value); // Use Manual Input

  if(!house || count < 1) return alert("Enter House and Members");
  if(!slValue) return alert("Enter SL No");

  let btn = document.getElementById("btnSave");
  btn.disabled = true; btn.textContent = "Saving & Organizing...";

  let names = document.querySelectorAll(".inp-name");
  let books = document.querySelectorAll(".inp-book");
  let serials = document.querySelectorAll(".inp-serial");
  let religions = document.querySelectorAll(".sel-religion");
  let parties = document.querySelectorAll(".sel-party");
  let actives = document.querySelectorAll(".sel-active");

  for (let i = 0; i < names.length; i++) {
    await apiCall({
      mode: "saveData",
      sheetId: currentSheetId,
      slno: slValue, // Send manual SL
      house: house,
      count: count,
      name: names[i].value,
      book: books[i].value,
      serial: serials[i].value,
      religion: religions[i].value,
      party: parties[i].value,
      active: actives[i].value,
      showMain: i === 0 
    });
  }

  // Update Suggestion for next entry
  let data = await apiCall({ mode: "getLastSL", sheetId: currentSheetId });
  if (data) {
    document.getElementById("manualSL").value = Number(data.lastSL) + 1;
  }

  // Clear Form
  document.getElementById("members").innerHTML = "";
  document.getElementById("count").value = "";
  document.getElementById("house").value = "";
  
  btn.textContent = "üíæ Save Family & Fix Order";
  btn.disabled = false;
}

// --- FILTER & EXCEL ---
async function applyFilter() {
  let filters = {
    active: document.getElementById("fActive").value,
    party: document.getElementById("fParty").value,
    religion: document.getElementById("fReligion").value,
    book: document.getElementById("fBook").value.trim(),
    serial: document.getElementById("fSerial").value.trim()
  };

  let data = await apiCall({ mode: "filter", sheetId: currentSheetId, filters: filters });

  if (data) {
    let s = data.summary;
    document.getElementById("filterSummary").innerHTML = `<b>Total:</b> ${s.total} | Active: ${s.active} | Inactive: ${s.notActive} <br> NDA: ${s.party.NDA}, UDF: ${s.party.UDF}, LDF: ${s.party.LDF}`;
    
    let html = "<table><tr><th>SL</th><th>House</th><th>Name</th><th>Book</th><th>Party</th></tr>";
    data.data.forEach(r => html += `<tr><td>${r.slno}</td><td>${r.house}</td><td>${r.name}</td><td>${r.book}</td><td>${r.party}</td></tr>`);
    document.getElementById("filterResults").innerHTML = html + "</table>";
  }
}

function openExcel() { window.open("https://docs.google.com/spreadsheets/d/" + currentSheetId, "_blank"); }
function downloadCSV() { window.open("https://docs.google.com/spreadsheets/d/" + currentSheetId + "/export?format=csv", "_blank"); }

// Init
loadFiles();
</script>

</body>
</html>
