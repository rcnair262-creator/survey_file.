<!DOCTYPE html>
<html>
<head>
  <title>Election Survey System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* --- STYLES --- */
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; padding: 20px; color: #333; }
    
    .box {
      background: white; padding: 25px; max-width: 900px; margin: auto;
      border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    h2 { margin-top: 0; color: #444; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }

    label { font-weight: 600; font-size: 14px; color: #555; display: block; margin-top: 10px; }

    input, select, button {
      width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px;
      border: 1px solid #ccc; font-size: 15px; box-sizing: border-box;
    }

    input:focus, select:focus { border-color: #2b7cff; outline: none; }

    button {
      background: #2b7cff; color: white; border: none; font-weight: bold;
      cursor: pointer; transition: background 0.2s;
    }
    button:hover { background: #1a66e0; }
    button:disabled { background: #ccc; cursor: not-allowed; }

    button.red { background: #d43b3b; }
    button.red:hover { background: #b02a2a; }
    
    button.green { background: #28a745; }
    button.green:hover { background: #218838; }

    .member-card {
      background: #f9f9f9; padding: 15px; border: 1px solid #eee;
      border-radius: 8px; margin-bottom: 15px;
    }

    /* SL Number Badge */
    .sl-badge {
      background: #ffeb3b; color: #000; padding: 5px 12px;
      border-radius: 20px; font-weight: bold; border: 1px solid #e6d328;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    tr:nth-child(even) { background: #fafafa; }
    .status-active { color: green; font-weight: bold; }
    .status-inactive { color: red; font-weight: bold; }
  </style>
</head>
<body>

<script>
/* ‚ö†Ô∏è ACTION REQUIRED: 
   Paste your NEW Web App URL inside the quotes below. 
   If you deployed a "New Version", the URL might be the same, 
   but ensure it is the one ending in /exec 
*/
const LIVE_URL = "https://script.google.com/macros/s/AKfycbxsiECJkDUscrGRW5lp579YZZTYgpomb-mNR2s6Pt6XzhNy86EH0ogu9WLM5AByWwrkqw/exec";

let currentSheetId = "";
let autoSL = 1; // This variable tracks the current SL Number
</script>

<div class="box" id="dashboard">
  <h2>üìÇ Cluster Dashboard</h2>
  
  <label>Select Existing Cluster File</label>
  <button id="btnLoad" onclick="loadFiles()">üîÑ Refresh File List</button>
  <select id="fileList"><option>Loading...</option></select>
  <button class="green" onclick="selectFile()">Open Selected File</button>

  <hr>

  <label>Create New Cluster</label>
  <input id="newCluster" placeholder="Enter Cluster Name (e.g., Ward 5)">
  <button onclick="createNewCluster()">‚ûï Create New File</button>

  <hr>
  <button onclick="openFilter()">üîç Advanced Search & Filter</button>
</div>

<div class="box" id="familyBox" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>üìù Family Entry</h2>
    <div>SL No: <span id="displaySL" class="sl-badge">1</span></div>
  </div>

  <label>House Name</label>
  <input id="house" placeholder="Enter House Name">

  <label>Number of Eligible Members</label>
  <input type="number" id="count" placeholder="0" onchange="createMembers()">

  <div id="members"></div>

  <button id="btnSave" class="green" onclick="saveFamily()">üíæ Save Family</button>
  <button class="red" onclick="backToDashboard()">Back to Dashboard</button>
</div>

<div class="box" id="filterBox" style="display:none;">
  <h2>üìä Filter & Summary</h2>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <select id="fActive">
      <option value="">All Status</option>
      <option>Active</option>
      <option>Not Active</option>
    </select>
    <select id="fParty">
      <option value="">All Party</option>
      <option>NDA</option>
      <option>UDF</option>
      <option>LDF</option>
      <option>OTH</option>
    </select>
  </div>

  <select id="fReligion">
    <option value="">All Religion</option>
    <option>Hindu</option>
    <option>Muslim</option>
    <option>Christian</option>
    <option>Others</option>
  </select>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <input id="fBook" placeholder="Book No">
    <input id="fSerial" placeholder="Serial No">
  </div>

  <button onclick="applyFilter()">Apply Filter</button>
  
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <button class="green" onclick="openExcel()">Open Sheet</button>
    <button class="green" onclick="downloadCSV()">Download CSV</button>
  </div>
  
  <button class="red" onclick="backToDashboard()">Back</button>

  <div id="filterSummary" style="margin-top:15px; padding:10px; background:#e8f0fe; border-radius:5px; font-size:14px;"></div>
  <div id="filterResults" style="overflow-x:auto;"></div>
</div>

<script>
// --- Navigation ---
function showPage(id) {
  document.querySelectorAll('.box').forEach(b => b.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}

function backToDashboard() {
  showPage("dashboard");
}

// --- API Helper ---
async function apiCall(data) {
  try {
    let res = await fetch(LIVE_URL, {
      method: "POST",
      body: JSON.stringify(data)
    });
    return await res.json();
  } catch (err) {
    alert("Connection Error: " + err.message);
    return null;
  }
}

// --- Dashboard Functions ---
async function loadFiles() {
  let btn = document.getElementById("btnLoad");
  btn.textContent = "Loading...";
  btn.disabled = true;

  let data = await apiCall({ mode: "listFiles" });
  
  let list = document.getElementById("fileList");
  list.innerHTML = "";

  if (data && data.files) {
    data.files.forEach(f => {
      let opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = f.name;
      list.appendChild(opt);
    });
    if(data.files.length === 0) {
      let opt = document.createElement("option");
      opt.textContent = "No files found";
      list.appendChild(opt);
    }
  }

  btn.textContent = "üîÑ Refresh File List";
  btn.disabled = false;
}

async function selectFile() {
  currentSheetId = document.getElementById("fileList").value;
  if (!currentSheetId || currentSheetId === "Loading..." || currentSheetId === "No files found") {
    return alert("Please select a valid file first.");
  }

  let btn = document.querySelector("button[onclick='selectFile()']");
  btn.textContent = "Opening...";
  btn.disabled = true;

  // Get last SL number from server
  let data = await apiCall({ mode: "getLastSL", sheetId: currentSheetId });
  
  btn.textContent = "Open Selected File";
  btn.disabled = false;

  if (data) {
    // Backend returns the LAST used SL (e.g., 5). We need 5 + 1 = 6.
    autoSL = Number(data.lastSL) + 1;
    document.getElementById("displaySL").textContent = autoSL;
    showPage("familyBox");
  }
}

async function createNewCluster() {
  let name = document.getElementById("newCluster").value.trim();
  if (!name) return alert("Enter cluster name");

  let btn = document.querySelector("button[onclick='createNewCluster()']");
  btn.disabled = true; btn.textContent = "Creating...";

  let data = await apiCall({ mode: "createFile", clusterName: name });

  btn.disabled = false; btn.textContent = "‚ûï Create New File";

  if (data) {
    if (data.status === "EXISTS") return alert("File with this name already exists!");
    
    currentSheetId = data.sheetId;
    autoSL = 1; // New file starts at 1
    document.getElementById("displaySL").textContent = autoSL;
    showPage("familyBox");
  }
}

// --- Family Entry Functions ---
function createMembers() {
  let count = Number(document.getElementById("count").value);
  let box = document.getElementById("members");
  box.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    box.innerHTML += `
      <div class="member-card">
        <h4 style="margin-top:0;">Member ${i}</h4>
        <input placeholder="Name" class="inp-name">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input placeholder="Book No" class="inp-book">
          <input placeholder="Serial No" class="inp-serial">
        </div>

        <select class="sel-religion">
          <option>Hindu</option>
          <option>Muslim</option>
          <option>Christian</option>
          <option>Others</option>
        </select>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <select class="sel-party">
            <option>NDA</option>
            <option>UDF</option>
            <option>LDF</option>
            <option>OTH</option>
          </select>

          <select class="sel-active">
            <option>Active</option>
            <option>Not Active</option>
          </select>
        </div>
      </div>
    `;
  }
}

async function saveFamily() {
  let house = document.getElementById("house").value.trim();
  let count = Number(document.getElementById("count").value);
  
  if(!house || count < 1) return alert("Please enter House Name and at least 1 member.");

  let btn = document.getElementById("btnSave");
  btn.disabled = true;

  // Gather Inputs
  let names = document.querySelectorAll(".inp-name");
  let books = document.querySelectorAll(".inp-book");
  let serials = document.querySelectorAll(".inp-serial");
  let religions = document.querySelectorAll(".sel-religion");
  let parties = document.querySelectorAll(".sel-party");
  let actives = document.querySelectorAll(".sel-active");

  for (let i = 0; i < names.length; i++) {
    btn.textContent = `Saving Member ${i+1} of ${count}...`;
    
    await apiCall({
      mode: "saveData",
      sheetId: currentSheetId,
      slno: autoSL, // Send the CURRENT SL
      house: house,
      count: count,
      name: names[i].value,
      book: books[i].value,
      serial: serials[i].value,
      religion: religions[i].value,
      party: parties[i].value,
      active: actives[i].value,
      showMain: i === 0 // Only first member gets SL/House/Count data
    });
  }

  // ‚úÖ CRITICAL FIX: Increment SL AFTER saving is complete
  autoSL = autoSL + 1;
  document.getElementById("displaySL").textContent = autoSL;
  
  // Clear Inputs for next family
  document.getElementById("members").innerHTML = "";
  document.getElementById("count").value = "";
  document.getElementById("house").value = "";
  
  btn.textContent = "üíæ Save Family";
  btn.disabled = false;
  
  // Optional: Tiny toast or alert
  // alert("Family Saved! Moving to SL: " + autoSL);
}

// --- Filter Functions ---
function openFilter() {
  if(!currentSheetId) return alert("Please load and select a file first from Dashboard.");
  showPage("filterBox");
}

async function applyFilter() {
  let btn = document.querySelector("button[onclick='applyFilter()']");
  btn.textContent = "Filtering...";
  btn.disabled = true;

  let filters = {
    active: document.getElementById("fActive").value,
    party: document.getElementById("fParty").value,
    religion: document.getElementById("fReligion").value,
    book: document.getElementById("fBook").value.trim(),
    serial: document.getElementById("fSerial").value.trim()
  };

  let data = await apiCall({
    mode: "filter",
    sheetId: currentSheetId,
    filters: filters
  });

  btn.textContent = "Apply Filter";
  btn.disabled = false;

  if (data) {
    let s = data.summary;
    let summaryHtml = `
      <b>Total:</b> ${s.total} &nbsp;|&nbsp; 
      <span style="color:green">Active: ${s.active}</span> &nbsp;|&nbsp; 
      <span style="color:red">Inactive: ${s.notActive}</span><br>
      <small>NDA: ${s.party.NDA} | UDF: ${s.party.UDF} | LDF: ${s.party.LDF} | OTH: ${s.party.OTH}</small>
    `;
    document.getElementById("filterSummary").innerHTML = summaryHtml;

    let html = `<table>
      <tr>
        <th>SL</th><th>House</th><th>Name</th>
        <th>Book</th><th>Sl.No</th>
        <th>Rel</th><th>Party</th><th>Status</th>
      </tr>`;

    data.data.forEach(r => {
      let statusClass = r.active === "Active" ? "status-active" : "status-inactive";
      html += `<tr>
        <td>${r.slno}</td>
        <td>${r.house}</td>
        <td>${r.name}</td>
        <td>${r.book}</td>
        <td>${r.serial}</td>
        <td>${r.religion}</td>
        <td>${r.party}</td>
        <td class="${statusClass}">${r.active}</td>
      </tr>`;
    });

    html += "</table>";
    document.getElementById("filterResults").innerHTML = html;
  }
}

function openExcel() {
  if(currentSheetId) window.open("https://docs.google.com/spreadsheets/d/" + currentSheetId, "_blank");
}

function downloadCSV() {
  if(currentSheetId) window.open("https://docs.google.com/spreadsheets/d/" + currentSheetId + "/export?format=csv", "_blank");
}

// Initial Load
loadFiles();
</script>

</body>
</html>
